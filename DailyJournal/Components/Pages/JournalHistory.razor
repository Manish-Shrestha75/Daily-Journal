@page "/journal-history"
@using DailyJournal.Models
@using DailyJournal.Services.Interfaces
@inject IJournalService JournalService

<div class="container mt-4">
    <h3 class="text-primary mb-3">📜 Journal History</h3>

    <div class="input-group mb-4">
        <input type="text" class="form-control" placeholder="Search entries..." @bind="searchText" />
        <button class="btn btn-outline-primary" @onclick="PerformSearch">🔍 Search</button>
    </div>

    @if (entries == null)
    {
        <p>Loading...</p>
    }
    else if (entries.Count == 0)
    {
        <div class="alert alert-info">No entries found.</div>
    }
    else
    {
        <div class="list-group">
            @foreach (var entry in entries)
            {
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">@entry.EntryDate.ToShortDateString() <small>@Mood.GetEmoji(entry.PrimaryMood)</small></h5>
                        <p class="mb-1 text-muted">@entry.Content.Substring(0, Math.Min(50, entry.Content.Length))...</p>
                    </div>
                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteEntry(entry)">🗑️</button>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<JournalEntry>? entries;
    private string searchText = "";

    protected override async Task OnInitializedAsync()
    {
        entries = await JournalService.GetHistoryAsync();
    }

    private async Task PerformSearch()
    {
        entries = await JournalService.SearchJournalAsync(searchText);
    }

    private async Task DeleteEntry(JournalEntry entry)
    {
        bool confirm = await Application.Current.MainPage.DisplayAlert("Delete", "Are you sure?", "Yes", "No");
        if (confirm)
        {
            await JournalService.DeleteEntryAsync(entry);
            await PerformSearch(); // Refresh list
        }
    }
}